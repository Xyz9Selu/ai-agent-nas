# AI Agent NAS 服务 - 群晖部署说明

本文档详细介绍如何将 AI Agent NAS 服务打包成 Docker 镜像并部署到群晖 NAS 系统。

## 🔍 服务简介

本服务是一个集成环境，包含以下组件：

- **PostgreSQL 16**：数据库服务（端口 5432）
  - `n8n` 数据库：用于 n8n 工作流数据存储
  - `ai_agent` 数据库：用于 AI 应用，集成 pgvector 向量扩展
- **n8n**：工作流自动化平台（端口 5678）
- **n8n-service**：Flask API 服务（端口 5000）
  - 提供 Google Drive SAP 数据解析功能
  - 支持数据库写入和 JSONL 导出

---

## 💻 环境要求

### 开发环境（构建镜像）
- Docker Engine 20.10+
- Docker Compose 2.0+
- 至少 2GB 可用磁盘空间

### 群晖 NAS
- DSM 7.0 或更高版本
- 已安装 Container Manager（原 Docker）套件
- 至少 4GB RAM
- 至少 5GB 可用存储空间

---

## 🚀 部署步骤

### 步骤一：准备配置文件

> 💡 **说明：** 环境变量将在群晖 Container Manager 界面中配置，无需手动编辑 .env 文件。

#### Google 认证配置（可选）

本服务支持两种 Google 认证方式，根据使用场景选择配置：

**配置 1：Service Account（用于 n8n-service API）**

如果需要使用 n8n-service 的 Google Drive API 功能（Flask 后端服务）：

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目
3. 启用所需的 API（如 Google Drive API）
4. 进入「API 和服务」→「凭据」
5. 点击「创建凭据」→「服务账号」
6. 填写服务账号信息并创建
7. 进入服务账号详情，点击「密钥」→「添加密钥」→「创建新密钥」
8. 选择 JSON 格式，下载密钥文件
9. 将下载的 JSON 文件重命名为 `service_account.json`
10. 保存到项目的 `n8n-service/` 目录下
11. 在步骤五配置容器时，将此文件挂载到容器内

> 💡 **提示：** Service Account 适用于服务端 API 调用，无需用户交互授权。

**配置 2：OAuth APP（用于 n8n 的 Google Drive 节点）**

如果需要在 n8n 工作流中使用 Google Drive、Google Sheets 等节点：

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建新项目或选择现有项目（可与 Service Account 使用同一项目）
3. 启用所需的 API（如 Google Drive API、Google Sheets API）
4. 进入「API 和服务」→「凭据」
5. 点击「创建凭据」→「OAuth 客户端 ID」
6. 应用类型选择「Web 应用」
7. 添加授权重定向 URI：
   - `https://your-nas-host/rest/oauth2-credential/callback`
   - 例如：`https://nas-host/rest/oauth2-credential/callback`
8. 创建后，保存 **客户端 ID** 和 **客户端密钥**

服务启动后，在 n8n 界面中：
1. 点击右上角「设置」→「Credentials」
2. 点击「New Credential」
3. 选择「Google OAuth2 API」
4. 填入刚才获取的：
   - Client ID（客户端 ID）
   - Client Secret（客户端密钥）
5. 点击「Connect my account」完成 OAuth 授权
6. 授权成功后即可在工作流中使用 Google 相关节点

> 💡 **提示：** OAuth APP 适用于需要用户授权的场景，支持在 n8n 界面中管理多个 Google 账号。

#### 需要准备的配置参数

在后续步骤中，你需要在群晖容器服务界面配置以下环境变量。建议先记录或准备好这些信息：

**必填参数：**
- **数据库密码**：`POSTGRES_PASSWORD`、`N8N_POSTGRES_PASSWORD`（请设置强密码）
- **n8n 登录密码**：`N8N_BASIC_AUTH_PASSWORD`（请设置强密码）
- **NAS IP 地址**：用于 `N8N_HOST` 配置（如 `192.168.1.100`）

**可选参数：**
- **邮件服务器配置**（如需 n8n 发送邮件）
- **时区设置**（默认 `Asia/Shanghai`）
- **向量维度**（默认 `3072`）

> ⚠️ **安全提示：** 所有密码必须修改为强密码，不要使用默认值！


### 步骤四：导入镜像到群晖

1. 登录群晖 DSM
2. 打开「Container Manager」套件
3. 进入「映像」标签页
4. 点击「新增」→「从文件添加」
5. 上传 `ai-agent-nas.tar` 文件
6. 等待导入完成

### 步骤五：在群晖上运行容器

1. 进入「Container Manager」→「容器」
2. 点击「新增」→「通过映像创建」
3. 选择导入的 `ai-agent-nas` 镜像
4. 配置容器参数：

**常规设置：**
- 容器名称：`ai-agent-nas`
- 启用自动重新启动：勾选

**端口设置：**
| 本地端口 | 容器端口 | 类型 | 说明 |
|---------|---------|------|------|
| 5432 | 5432 | TCP | PostgreSQL |
| 5678 | 5678 | TCP | n8n Web 界面 |
| 5000 | 5000 | TCP | n8n-service API |

**存储空间设置（卷映射）：**

在「存储空间」标签中，添加以下文件夹映射：

| 本地路径 | 挂载路径 | 说明 |
|---------|---------|------|
| `/volume1/docker/ai-agent-nas/data` | `/data` | 通用数据 |
| `/volume1/docker/ai-agent-nas/postgresql-data` | `/var/lib/postgresql` | PostgreSQL 数据 |
| `/volume1/docker/ai-agent-nas/n8n-data` | `/root/.n8n` | n8n 配置和工作流 |

**可选：如果使用 n8n-service API，还需添加：**

| 本地路径 | 挂载路径 | 说明 |
|---------|---------|------|
| `/volume1/docker/ai-agent-nas/n8n-service/service_account.json` | `/app/n8n-service/service_account.json` | Google Service Account（只读）|

> 💡 **提示：** 
> - 确保在群晖上创建这些目录：`mkdir -p /volume1/docker/ai-agent-nas/{data,postgresql-data,n8n-data}`
> - 如果使用 Service Account，需要先将 `service_account.json` 上传到 `/volume1/docker/ai-agent-nas/n8n-service/` 目录

**环境变量设置：**

在「环境」标签中，点击「+」添加以下环境变量。所有环境变量都必须逐个添加：

#### 基础配置

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `TZ` | `Asia/Shanghai` | 时区设置，影响定时任务执行时间 | ✅ |
| `GENERIC_TIMEZONE` | `Asia/Shanghai` | n8n 时区（建议与 TZ 一致）| ✅ |

#### 端口配置

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `N8N_PORT` | `5678` | n8n Web 界面端口（容器内）| ❌ |
| `PORT` | `5000` | n8n-service API 端口 | ❌ |

#### PostgreSQL 主数据库（n8n 工作流）

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `POSTGRES_DB` | `n8n` | n8n 工作流数据库名 | ✅ |
| `POSTGRES_USER` | `n8nuser` | 数据库用户名 | ✅ |
| `POSTGRES_PASSWORD` | `设置强密码` | ⚠️ **必须修改**为强密码 | ✅ |

#### PostgreSQL AI Agent 数据库

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `N8N_POSTGRES_DB` | `ai_agent` | AI agent 数据库名 | ✅ |
| `N8N_POSTGRES_USER` | `n8nuser` | AI 数据库用户名 | ✅ |
| `N8N_POSTGRES_PASSWORD` | `设置强密码` | ⚠️ **必须修改**为强密码 | ✅ |

#### n8n 认证配置

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `N8N_BASIC_AUTH_USER` | `admin` | n8n 登录用户名 | ✅ |
| `N8N_BASIC_AUTH_PASSWORD` | `设置强密码` | ⚠️ **必须修改** n8n 登录密码 | ✅ |

#### n8n 网络配置

| 变量名 | 示例值 | 说明 | 必填 |
|--------|--------|------|------|
| `N8N_HOST` | `192.168.1.100` | 替换为你的群晖 NAS IP 地址 | ✅ |
| `WEBHOOK_URL` | `http://192.168.1.100:5678` | Webhook URL（与 N8N_HOST 对应）| ✅ |
| `N8N_SECURE_COOKIES` | `false` | HTTP 用 false，HTTPS 用 true | ❌ |

#### n8n 数据库连接配置

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `DB_TYPE` | `postgresdb` | 数据库类型 | ✅ |
| `DB_POSTGRESDB_HOST` | `localhost` | 数据库主机（容器内）| ✅ |
| `DB_POSTGRESDB_PORT` | `5432` | 数据库端口 | ✅ |
| `DB_POSTGRESDB_DATABASE` | `n8n` | n8n 使用的数据库名（与 POSTGRES_DB 一致）| ✅ |
| `DB_POSTGRESDB_USER` | `n8nuser` | 数据库用户（与 POSTGRES_USER 一致）| ✅ |
| `DB_POSTGRESDB_PASSWORD` | 与 `POSTGRES_PASSWORD` 相同 | 数据库密码（与 POSTGRES_PASSWORD 一致）| ✅ |

#### 向量数据库配置

| 变量名 | 建议值 | 说明 | 必填 |
|--------|--------|------|------|
| `VECTOR_SIZE` | `3072` | pgvector 向量维度<br>3072 = text-embedding-3-large<br>1536 = text-embedding-3-small | ❌ |

#### 邮件配置（可选）

如果需要 n8n 发送邮件通知，配置以下变量：

| 变量名 | 示例值 | 说明 | 必填 |
|--------|--------|------|------|
| `N8N_EMAIL_MODE` | `smtp` | 邮件模式 | ❌ |
| `N8N_SMTP_HOST` | `smtp.gmail.com` | SMTP 服务器地址 | ❌ |
| `N8N_SMTP_PORT` | `465` | SMTP 端口 | ❌ |
| `N8N_SMTP_USER` | `your-email@gmail.com` | 邮箱账号 | ❌ |
| `N8N_SMTP_PASS` | `your-app-password` | 邮箱应用专用密码 | ❌ |
| `N8N_SMTP_SENDER` | `your-email@gmail.com` | 发件人地址 | ❌ |
| `N8N_SMTP_SSL` | `true` | 启用 SSL | ❌ |

> ⚠️ **重要提醒：**
> - 所有标记为"设置强密码"的字段必须修改为复杂密码
> - `N8N_HOST` 必须设置为群晖 NAS 的实际 IP 地址或域名
> - `WEBHOOK_URL` 必须与 `N8N_HOST` 保持一致
> - 数据库相关的用户名和密码必须在多处保持一致

**配置示例：**

假设你的群晖 IP 是 `192.168.1.100`，数据库密码设为 `MySecurePass2024!`，以下是完整配置示例：

```
TZ=Asia/Shanghai
GENERIC_TIMEZONE=Asia/Shanghai
POSTGRES_DB=n8n
POSTGRES_USER=n8nuser
POSTGRES_PASSWORD=MySecurePass2024!
N8N_POSTGRES_DB=ai_agent
N8N_POSTGRES_USER=n8nuser
N8N_POSTGRES_PASSWORD=MySecurePass2024!
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=Admin@2024!
N8N_HOST=192.168.1.100
WEBHOOK_URL=http://192.168.1.100:5678
N8N_SECURE_COOKIES=false
VECTOR_SIZE=3072
PORT=5000
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=localhost
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8nuser
DB_POSTGRESDB_PASSWORD=MySecurePass2024!
```

5. 点击「完成」启动容器

---

## 🎯 n8n 配置说明

### 首次访问 n8n

1. 在浏览器中访问：`http://your-nas-ip:5678`
2. 使用以下凭证登录：
   - 用户名：`.env` 中的 `N8N_BASIC_AUTH_USER`（默认 `admin`）
   - 密码：`.env` 中的 `N8N_BASIC_AUTH_PASSWORD`

### 安装 Community Nodes

本服务推荐安装以下 n8n 社区节点以扩展功能：

#### 推荐节点列表

| 节点包名 | 功能说明 |
|---------|---------|
| `n8n-nodes-md-to-docs` | Markdown 文档处理和转换工具 |
| `n8n-nodes-smartcache` | 智能缓存节点，提高工作流性能 |

1. 登录 n8n Web 界面
2. 点击右上角「设置」图标（齿轮）
3. 进入「Community Nodes」页面
4. 点击「Install a community node」
5. 输入节点包名并安装：
   - 输入：`n8n-nodes-md-to-docs`，点击「Install」
   - 输入：`n8n-nodes-smartcache`，点击「Install」
6. 等待安装完成（可能需要 1-2 分钟）
7. 安装完成后，节点将自动出现在节点面板中

> **提示：** 如果安装失败，请查看容器日志排查错误


#### 验证安装

安装完成后，验证节点是否可用：

1. 在 n8n 中创建新工作流
2. 点击「+」添加节点
3. 搜索「md-to-docs」或「smartcache」
4. 如果节点出现在列表中，说明安装成功

### 添加Workflow

依次添加需要的工作节点

### 连接到 PostgreSQL 数据库

在 n8n 工作流中使用 PostgreSQL 节点时：

**连接配置：**
- Host: `localhost`
- Port: `5432`
- Database: `ai_agent`（或 `n8n`）
- User: `.env` 中的 `N8N_POSTGRES_USER`
- Password: `.env` 中的 `N8N_POSTGRES_PASSWORD`
- SSL: 关闭

### 配置 Webhooks

如果需要使用 n8n 的 Webhook 功能：

1. 确保 `.env` 中的 `N8N_HOST` 正确设置为外部可访问的域名或 IP
2. 如果群晖有公网 IP 和域名，配置反向代理（见下文）
3. Webhook URL 格式：`http://your-nas-ip:5678/webhook/your-webhook-path`


## 💾 数据持久化

### 数据存储位置

所有数据通过 Docker 卷持久化，即使容器重启或删除，数据也会保留：

| 数据类型 | 容器内路径 | 宿主机路径（群晖） |
|---------|----------|------------------|
| PostgreSQL 数据 | `/var/lib/postgresql` | `/volume1/docker/ai-agent-nas/postgresql-data` |
| n8n 工作流和凭证 | `/root/.n8n` | `/volume1/docker/ai-agent-nas/n8n-data` |
| 通用数据文件 | `/data` | `/volume1/docker/ai-agent-nas/data` |

### 数据库表结构

#### `ai_agent` 数据库包含以下表：

1. **documents** - 文档向量存储
   - `id`: 主键
   - `content`: 文档内容
   - `metadata`: JSON 元数据
   - `embedding`: 向量嵌入（维度由 `VECTOR_SIZE` 决定）

2. **memories** - 记忆向量存储
   - 结构同 `documents`

3. **document_metadata** - 文档元数据
   - `id`: 文档 ID
   - `title`: 标题
   - `url`: 来源 URL
   - `created_at`: 创建时间
   - `schema`: 模式定义

4. **document_rows** - SAP 数据行
   - `id`: 自增主键
   - `dataset_id`: 数据集标识
   - `row_data`: JSON 行数据

### 向量搜索函数

数据库提供以下函数用于向量相似度搜索：

- `match_documents(query_embedding, match_count, filter)`: 搜索文档
- `match_memories(query_embedding, match_count, filter)`: 搜索记忆

**在 n8n 中使用示例：**
```sql
SELECT * FROM match_documents(
  '[0.1, 0.2, ..., 0.3]'::vector(3072),
  10,
  '{"type": "report"}'::jsonb
);
```

### 备份和恢复

#### 备份数据库：
```bash
# 进入容器
sudo docker exec -it ai-agent-nas bash

# 备份 ai_agent 数据库
pg_dump -U n8nuser ai_agent > /data/ai_agent_backup.sql

# 备份 n8n 数据库
pg_dump -U n8nuser n8n > /data/n8n_backup.sql
```

#### 恢复数据库：
```bash
# 进入容器
sudo docker exec -it ai-agent-nas bash

# 恢复数据库
psql -U n8nuser ai_agent < /data/ai_agent_backup.sql
```


